name: Secret Scan

on:
  push:
    branches:
      - "*"
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1) Bloqueo si se detecta .env (o variantes)
      - name: Detect .env files
        run: |
          if git ls-files | grep -E "\.env(\..*)?$"; then
            echo "❌ Se detectó un archivo .env en el repo. El push será bloqueado."
            exit 1
          fi

      # 2) Escaneo avanzado de secretos (API Keys, JWT, tokens, passwords)
      - name: Run TruffleHog secret scanner
        uses: trufflesecurity/trufflehog@v3.68.0
        with:
          scanArguments: "--regex --entropy=True ."

      # 3) Fail job if secrets were found by TruffleHog
      - name: Check scan result
        run: |
          if [ -f ./trufflehog_results.json ]; then
            echo "❌ Se detectaron posibles secretos. Revisa el código antes de hacer push."
            exit 1
          fi
